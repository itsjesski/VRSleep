name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build and publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run dist

      - name: Extract Release Notes from CHANGELOG
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            
            // Extract the latest release section (first ## [version] section)
            const lines = changelog.split('\n');
            let releaseNotes = '';
            let foundFirstRelease = false;
            let inLatestRelease = false;
            
            for (const line of lines) {
              // Skip the main "# Changelog" header
              if (line.startsWith('# Changelog')) {
                continue;
              }
              
              // Start capturing when we hit the first release header
              if (line.startsWith('## [') && !foundFirstRelease) {
                foundFirstRelease = true;
                inLatestRelease = true;
                releaseNotes += line + '\n';
                continue;
              }
              
              // Stop capturing at the next release header
              if (inLatestRelease && line.startsWith('## [') && foundFirstRelease) {
                break;
              }
              
              // Capture all content until next release
              if (inLatestRelease) {
                releaseNotes += line + '\n';
              }
            }
            
            // Remove trailing empty lines and normalize
            releaseNotes = releaseNotes.trim();
            
            if (!releaseNotes) {
              releaseNotes = 'See CHANGELOG.md for details.';
            }
            
            core.setOutput('notes', releaseNotes);

      - name: Update Release with Changelog Notes
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const release = releases.data.find(r => r.tag_name === tag);
            
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: `${{ steps.changelog.outputs.notes }}`
              });
            }
